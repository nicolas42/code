<!DOCTYPE html>
<script>

function show(canvas, state)
{
    // let canvas = canvas.querySelector(".canvas");
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight;
    let ctx = canvas.getContext('2d');
    // pre.innerText += JSON.stringify(state) + '\n';

    // reset all transforms
    ctx.setTransform();
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(state.scale, state.scale);
    
    ctx.strokeStyle = state.color;
    ctx.lineWidth = state.line_width;

    for (let stroke_length = 0; stroke_length < state.max_distance; stroke_length += 1) {

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, stroke_length);
        ctx.stroke();

        ctx.translate(0, stroke_length);
        ctx.rotate(state.angle);
    }

    if ( state.show_state ) {
        let angle = 1 / ( state.angle / 2 / Math.PI )
        // let the_text = '1 / ' + JSON.stringify(angle).slice(0,10) + ' of a rotation';
        let the_text = JSON.stringify(state, function(key, val) { return val.toFixed ? Number(val.toFixed(10)) : val; }) // sets numbers to fixed length
        ctx.setTransform(); // reset all transforms
        ctx.fillStyle = "grey";
        ctx.font = "20px Verdana";
        ctx.fillText(the_text, 20 , canvas.height - 20);
    }

    // if ( ! state.is_moving ) { states.push(state); } // canvas.querySelector("pre").innerHTML += ( JSON.stringify(state) + "\n" ); }
}


function make_random_color()
{
    return "#" + Math.floor(Math.random() * 16777216).toString(16);
}

function make_random_angle()
{
    return Math.random() * 2 * Math.PI;
}


function start_stop_spiral(canvas, state)
{
    if ( !state.is_moving ) {
        clearInterval(state.timer_id);
        state.timer_id = setInterval( function(){ state.angle += 1e-5; show(canvas, state); }, 10 ); 
        state.is_moving = 1;
    } else {
        clearInterval(state.timer_id);
        state.is_moving = 0;
    }
}

function copy(obj) {

    let cp = {}; 
    for (key in obj) {
        cp[key] = obj[key];
    }
    return cp;
}

</script>


<style> * { margin: 0; padding: 0; } </style>

<div id="spiral">
    <canvas class="canvas">click me</canvas>
    <br>
    <input class="start_stop_button" type="button" value="start_stop_spiral">
    <input class="previous_button" type="button" value="previous_button">
    <input class="next_button" type="button" value="next_button">
    <input class="random_button" type="button" value="random_button">
    <input class="show_angle_checkbox" type="checkbox">
    <input  class="angle_slider" type="range" min="1" max="10000" value="5000">
    <input  class="scale_slider" type="range" min="1" max="200" value="100">
    <input  class="max_distance_slider" type="range" min="1" max="1000" value="500">
    <input  class="line_width_slider" type="range" min="1" max="10" value="1">
    <br>
    <audio controls>
        <source src="Paul Buckmaster - 12 monkeys-PPHqANTdXJw.opus" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <pre></pre>
    
</div>

<script>


let div = document.querySelector("div#spiral");
let canvas = div.querySelector(".canvas");

let state = { 
    angle: make_random_angle(),
    color: make_random_color(),
    max_distance: 500,
    scale: 1,
    line_width: 1,

    // step: 1
    timer_id: 0,
    is_moving: 0,
    show_state: 0,
}


states= [];
states_index= 0;

state.angle = make_random_angle(); state.color= make_random_color(); show(canvas,state); states.push(copy(state)); states_index = states.length-1;
canvas.onclick = function () { state.angle = make_random_angle(); state.color= make_random_color(); show(canvas,state); states.push(copy(state)); states_index = states.length-1; };
div.querySelector(".random_button").onclick = function () { state.angle = make_random_angle(); state.color= make_random_color(); show(canvas,state); states.push(copy(state)); states_index = states.length-1; };

div.querySelector(".previous_button").onclick = function() { states_index -= 1; if ( states_index < 0 ) { states_index = 0; } state = states[states_index]; show(canvas, state); }
div.querySelector(".next_button").onclick = function() { states_index += 1; if ( states_index > states.length-1 ) { states_index = states.length-1; } state = states[states_index]; show(canvas, state); }

div.querySelector(".start_stop_button").onclick = function() { start_stop_spiral(canvas,state); show(canvas,state); };
div.querySelector(".angle_slider").oninput = function() { state.angle = this.value / 10000 * 2 * Math.PI; show(canvas, state); }
div.querySelector(".max_distance_slider").oninput = function() { state.max_distance = this.value; show(canvas, state); }
div.querySelector(".scale_slider").oninput = function() { state.scale = this.value / 100; show(canvas, state); }
div.querySelector(".line_width_slider").oninput = function() { state.line_width = this.value; show(canvas, state); }
div.querySelector(".show_angle_checkbox").oninput = function() { state.show_state = this.checked; show(canvas, state); }
div.querySelector("pre");







// state.angle = Math.random() * 2 * Math.PI;
// state.color = make_random_color();


// let audio = spiral.querySelector("audio");
// if ( audio.paused ) { audio.play(); has_music_started = true; }

// let show_for_the_first_time = function(event) { console.log("one time deal"); show(canvas, state); canvas.removeEventListener("click", show_for_the_first_time ); }

// // Draw "Click Me" text
// let ctx = canvas.getContext('2d');
// let the_text = "Click Me";
// ctx.setTransform(); // reset all transforms
// ctx.fillStyle = "black";
// ctx.fillRect(0, 0, canvas.width, canvas.height);
// ctx.fillStyle = "grey";
// ctx.font = "60px Verdana";
// ctx.translate(canvas.width / 2, canvas.height / 2);
// ctx.fillText(the_text,0,0); // , canvas.width/2, canvas.height/2);



</script>

</html>

